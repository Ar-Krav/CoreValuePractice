<!--
 - Created by Ar-Krav on 24.01.2018.
 -->

<apex:page controller="DevicePageController" standardStylesheets="false">

    <head>
        <apex:includescript value="https://code.jquery.com/jquery-1.12.4.js"/>
        <link rel="stylesheet" type="text/css"
              href="https://cdn.datatables.net/1.10.16/css/jquery.dataTables.min.css"/>

        <link rel="stylesheet" type="text/css"
              href="https://cdn.datatables.net/select/1.2.5/css/select.dataTables.min.css"/>

        <script type="text/javascript" charset="utf8"
                src="//cdn.datatables.net/1.10.16/js/jquery.dataTables.js"></script>

        <script type="text/javascript" charset="utf8"
                src="https://cdn.datatables.net/select/1.2.5/js/dataTables.select.min.js"></script>


        <apex:includeScript value="{!$Resource.devicePageJS}"/>
        <link rel="stylesheet" type="text/css" href="{!$Resource.devicePageStyle}"/>
    </head>

    <script>
        function redrawDeviceDataTable(){
            return $('#devices-table').DataTable( {
                "paging":   false,
                "info":     false,
                select: true,
            } );
        }

        var deviceTable;

        $(document).ready(function() {
            deviceTable = redrawDeviceDataTable();
            configTable = redrawConfigurationDataTable();
            pageButtonClick();
        } );

        var configTable;

        function redrawConfigurationDataTable() {
            return $('#configuration-table').DataTable( {
                        "paging":   false,
                        "info":     false
                    } );
        }
    </script>

    <style>
        .ellipsis{
            padding:0 1em;
        }

        .paginate-button.current{
            color:#333 !important;
            border:1px solid #979797;
            background-color:white;
            background:-webkit-gradient(linear, left top, left bottom, color-stop(0%, #fff), color-stop(100%, #dcdcdc));
            background:-webkit-linear-gradient(top, #fff 0%, #dcdcdc 100%);background:-moz-linear-gradient(top, #fff 0%, #dcdcdc 100%);
            background:-ms-linear-gradient(top, #fff 0%, #dcdcdc 100%);background:-o-linear-gradient(top, #fff 0%, #dcdcdc 100%);
            background:linear-gradient(to bottom, #fff 0%, #dcdcdc 100%)
        }

        .paginate-button.current:hover{
            color:#333 !important;
            border:1px solid #979797;
            background-color:white;
            background:-webkit-gradient(linear, left top, left bottom, color-stop(0%, #fff), color-stop(100%, #dcdcdc));
            background:-webkit-linear-gradient(top, #fff 0%, #dcdcdc 100%);
            background:-moz-linear-gradient(top, #fff 0%, #dcdcdc 100%);
            background:-ms-linear-gradient(top, #fff 0%, #dcdcdc 100%);
            background:-o-linear-gradient(top, #fff 0%, #dcdcdc 100%);
            background:linear-gradient(to bottom, #fff 0%, #dcdcdc 100%) !important;
        }

        .paginate-button{
            box-sizing: border-box;
            display: inline-block;
            min-width: 1.5em;
            padding: 0.5em 1em;
            margin-left: 2px;
            text-align: center;
            cursor: pointer;
            color: #333 !important;
            background-color: transparent;
            text-decoration: none !important;
            border: 1px solid transparent;
            border-radius: 2px;
        }

        .paginate-button:active{
            outline:none;
            background-color:#2b2b2b;
            background:-webkit-gradient(linear, left top, left bottom, color-stop(0%, #2b2b2b), color-stop(100%, #0c0c0c));
            background:-webkit-linear-gradient(top, #2b2b2b 0%, #0c0c0c 100%);
            background:-moz-linear-gradient(top, #2b2b2b 0%, #0c0c0c 100%);
            background:-ms-linear-gradient(top, #2b2b2b 0%, #0c0c0c 100%);
            background:-o-linear-gradient(top, #2b2b2b 0%, #0c0c0c 100%);
            background:linear-gradient(to bottom, #2b2b2b 0%, #0c0c0c 100%) !important;
            box-shadow:inset 0 0 3px #111;
        }

        .paginate-button:hover{
            color:white !important;
            border:1px solid #111;
            background-color:#585858;
            background:-webkit-gradient(linear, left top, left bottom, color-stop(0%, #585858), color-stop(100%, #111));
            background:-webkit-linear-gradient(top, #585858 0%, #111 100%);background:-moz-linear-gradient(top, #585858 0%, #111 100%);
            background:-ms-linear-gradient(top, #585858 0%, #111 100%);background:-o-linear-gradient(top, #585858 0%, #111 100%);
            background:linear-gradient(to bottom, #585858 0%, #111 100%)
        }

        .paginate-button.disabled,.paginate-button.disabled:hover,.paginate-button.disabled:active{
            pointer-events: none;
            cursor:default;
            color:#666 !important;
            border:1px solid transparent;
            background:transparent;
            box-shadow:none
        }
    </style>

    <script>
        function pageButtonClick() {
            var htmlCode = '<button type="button" onClick="searchWithFilter(\'\',\'\',\'\');">RESET FILTERS</button>';
            document.getElementById('devices-table_wrapper').insertAdjacentHTML('afterBegin',htmlCode);

            var buttonsBlock = document.getElementById('page-buttons-block');
            var lastButtonBlock = document.getElementById('last-page-button-block');

            console.log('currentPage: ' + currentPage);
            console.log('currentPage: ' + {!devicePaginationController.pageNumber});

            var htmlCode='';

            if (currentPage == 1){
                document.getElementById('first-page-button').classList.add('current');
            }

            if (totalPages <= 6){
                for(var i = 2; i <= totalPages; i++){
                    htmlCode += checkNeccessaryHTMLCode(i, currentPage);
                }

                buttonsBlock.innerHTML = htmlCode;
                return;
            }


            if (totalPages > 0){
                htmlCode = '<input type="button" class="paginate-button" data-page="' + totalPages + '" value="' + totalPages + '" onclick="lastPage()"/>';
                lastButtonBlock.innerHTML = htmlCode;
            }

            htmlCode='';
            buttonsBlock.innerHTML = htmlCode;

            if(currentPage < 5){
                for(i = 2; i <= 5; i++){
                    htmlCode += checkNeccessaryHTMLCode(i, currentPage);
                }

                htmlCode += '<span class="ellipsis">…</span>';
            }
            else {
                if (totalPages - currentPage < 5){

                    console.log('PageMinus: ' + totalPages - currentPage);

                    htmlCode = '<span class="ellipsis">…</span>';

                    for(i = totalPages - 4; i < totalPages; i++){
                        htmlCode += checkNeccessaryHTMLCode(i, currentPage);
                    }
                }
                else {
                    htmlCode = '<span class="ellipsis">…</span>';

                    htmlCode += '<input type="button" class="paginate-button" data-page="' + (currentPage - 1) + '" value="' + (currentPage - 1) + '"/>';
                    htmlCode += '<input type="button" class="paginate-button current" data-page="' + currentPage + '" value="' + currentPage + '"/>';
                    htmlCode += '<input type="button" class="paginate-button" data-page="' + (currentPage + 1) + '" value="' + (currentPage + 1) + '"/>';

                    htmlCode += '<span class="ellipsis">…</span>';
                }
            }

            buttonsBlock.innerHTML = htmlCode;

            console.log('htmlDoC: ' + htmlCode);
        }

        function checkNeccessaryHTMLCode(i, currentPage) {
            var htmlCode='';

            if(i == currentPage){
                htmlCode += '<input type="button" class="paginate-button current" data-page="' + i + '" value="' + i + '" onclick="goToPage(this)"/>\n';
            }
            else {
                htmlCode += '<input type="button" class="paginate-button" data-page="' + i + '" value="' + i + '" onclick="goToPage(this)"/>\n';
            }

            return htmlCode;
        }
        
        function goToPage(element) {
            var pageNum = element.getAttribute('data-page');
            goToSelectedPageNum(pageNum);
        }
    </script>

    <apex:pageBlock>

        <apex:pageBlockButtons location="top">
            <apex:form >
                <apex:actionFunction name="changeLocation" action="{!sortDeviceByLocation}" rerender="device-list,configuration-info-block" status="deviceListReadyStatus">
                    <apex:param value="" name="selectedLocation"></apex:param>
                </apex:actionFunction>

                <apex:outputPanel id="city-selection-block" rendered="{!isShowLocationSelection}">
                    <apex:outputText style="color: #000;font-size: 1.2em;font-weight:bold;" value="Devices from:"/>

                    <select style="color: #000;font-size: 1.1em;" id="officeLocationsDropDown" onchange="sortDeviceByLocation()">
                            <option value="all-cities">All cities</option>
                            <apex:repeat value="{!adminsCities}" var="location">
                                <option value="{!location.id}">{!location.name}</option>
                            </apex:repeat>
                    </select>
                </apex:outputPanel>

            </apex:form>
        </apex:pageBlockButtons>

        <div id="main-box">
            <div id="device-block">
                <apex:form >
                    <apex:pageBlock title="Assemblies">

                        <apex:actionFunction action="{!setDeviceConfigurationListData}" name="showDeviceHardwareData" rerender="configuration-info-block,configuration-edit-button-block" status="configurationReadyStatus">
                            <apex:param name="deviceIdParameter" value="" />
                            <apex:param name="deviceImgUrl" value="" assignTo="{!deviceImageUrl}"/>
                        </apex:actionFunction>

                        <apex:actionFunction name="alertMonitorChanging" rerender="configuration-info-block,configuration-edit-button-block" action="{!alertMonitorChanging}" onComplete="alert('Only devices can be changed!');"/>

                        <apex:actionFunction action="{!setFilteredDeviceData}" name="searchWithFilter" rerender="device-list,configuration-info-block,configuration-edit-button-block" status="deviceListReadyStatus">
                            <apex:param name="deviceNameFilter" value="" assignTo="{!nameFilterValue}"/>
                            <apex:param name="deviceOwnerFilter" value="" assignTo="{!ownerFilterValue}"/>
                            <apex:param name="deviceSeriaFilter" value="" assignTo="{!seriaFilterValue}"/>
                            <apex:param name="deviceTypeFilter" value="" assignTo="{!typeFilterValue}"/>
                        </apex:actionFunction>

                        <apex:actionFunction name="previousPage" action="{!previous}" reRender="device-list,configuration-info-block"/>
                        <apex:actionFunction name="nextPage" action="{!next}" reRender="device-list,configuration-info-block"/>
                        <apex:actionFunction name="firstPage" action="{!first}" reRender="device-list,configuration-info-block"/>
                        <apex:actionFunction name="lastPage" action="{!last}" reRender="device-list,configuration-info-block"/>

                        <apex:actionFunction name="goToSelectedPageNum" action="{!goToSelectedPage}" reRender="device-list,configuration-info-block">
                            <apex:param value="" name="selectedPage"/>
                        </apex:actionFunction>

                        <apex:outputPanel id="device-list">
                            <script>
                                var totalPages = {!totalPagesNum};
                                var currentPage = {!devicePaginationController.pageNumber};

                                if (deviceTable != null){
                                    deviceTable.destroy();
                                }

                                deviceTable = redrawDeviceDataTable();
                                pageButtonClick();
                            </script>

                            <table id="devices-table" class="display" cellspacing="0">
                                <thead>
                                <tr>
                                    <th class="table-col-30"><apex:outputText value="{!$ObjectType.Hardware__c.Fields.Name.Label}"/></th>
                                    <th class="table-col-30"><apex:outputText value="{!$ObjectType.Hardware__c.Fields.AssignedToEmployee__c.Label}"/></th>
                                    <th class="table-col-25"><apex:outputText value="{!$ObjectType.Hardware__c.Fields.InvNo__c.Label}" /></th>
                                    <th class="table-col-20"><apex:outputText value="{!$Label.DeviceType}"/></th>
                                </tr>
                                </thead>

                                <tfoot>
                                <tr class="filters">
                                    <th class="table-col-30"><input class="filter-field" type="text" id="device-name-filter" value="{!nameFilterValue}" placeholder="{!$ObjectType.Hardware__c.Fields.Name.Label}" onkeypress="doDeviceFiltration(event)" /></th>
                                    <th class="table-col-30"><input class="filter-field" type="text" id="device-owner-filter" value="{!ownerFilterValue}" placeholder="{!$ObjectType.Hardware__c.Fields.AssignedToEmployee__c.Label}" onkeypress="doDeviceFiltration(event)" /></th>
                                    <th class="table-col-25"><input class="filter-field" type="text" id="device-seria-filter" value="{!seriaFilterValue}" placeholder="{!$ObjectType.Hardware__c.Fields.InvNo__c.Label}" onkeypress="doDeviceFiltration(event)" /></th>
                                    <th class="table-col-20"><input class="filter-field" type="text" id="device-type-filter" value="{!typeFilterValue}" placeholder="{!$Label.DeviceType}" onkeypress="doDeviceFiltration(event)" /></th>
                                </tr>
                                </tfoot>

                                <tbody>
                                <apex:repeat value="{!deviceList}" var="deviceUnit">
                                    <tr onclick="selectRow('{!deviceUnit.RecordType.name}', '{!deviceUnit.id}', '{!deviceUnit.ImageUrl__c}')">
                                        <td class="table-col-30" title="{!deviceUnit.name}">
                                            <p class="overlapping-text"><apex:outputText value="{!deviceUnit.name}" /></p>
                                        </td>

                                        <td class="table-col-30" title="{!deviceUnit.assignedToEmployee__r.name}">
                                            <p class="overlapping-text"><apex:outputText value="{!deviceUnit.assignedToEmployee__r.name}" /></p>
                                        </td>

                                        <td class="table-col-25" title="{!deviceUnit.InvNo__c}">
                                            <p class="overlapping-text"><apex:outputText value="{!deviceUnit.InvNo__c}" /></p>
                                        </td>

                                        <td class="table-col-20" title="{!deviceUnit.RecordType.name}">
                                            <p class="overlapping-text"><apex:outputText value="{!deviceUnit.RecordType.name}" /></p>
                                        </td>
                                    </tr>
                                </apex:repeat>
                                </tbody>
                            </table>

                            <br/>

                            <div id="pagination-buttons-block">
                                <input type="button" class="paginate-button {!IF(devicePaginationController.hasPrevious,'','disabled')}" value="Previous" onclick="previousPage()"/>
                                <input id="first-page-button" type="button" class="paginate-button" value="1" onclick="firstPage()"/>

                                <div style="display:inline-block" id="page-buttons-block"></div>
                                <div style="display:inline-block" id="last-page-button-block"></div>

                                <input type="button" value="Next" class="paginate-button {!IF(devicePaginationController.hasNext,'','disabled')}" onclick="nextPage()"/>
                            </div>

                        </apex:outputPanel>
                    </apex:pageBlock>
                </apex:form>
            </div>


            <div id="configuration-info">
                <apex:form>
                    <apex:outputPanel id="configuration-info-block">

                        <apex:pageBlock title="Configurations" >

                            <apex:pageBlockButtons location="top">
                                <apex:outputPanel id="configuration-edit-button-block">
                                    <apex:commandButton action="{!redirectToConfigurationEditorPage}" rendered="{!deviceConfigurationList != null}" value="Edit configuration"/>
                                </apex:outputPanel>
                            </apex:pageBlockButtons>

                            <apex:outputPanel rendered="{!deviceConfigurationList != null}">

                                <script>
                                    if ( configTable != null ) {
                                        configTable.destroy();
                                    }

                                    configTable = redrawConfigurationDataTable();
                                </script>

                                <table id="configuration-table" class="display dataTable no-footer">
                                    <thead>
                                        <tr>
                                            <th class="table-col-40"><apex:outputText value="{!$ObjectType.Hardware__c.Fields.Name.Label}"/></th>
                                            <th class="table-col-30"><apex:outputText value="{!$ObjectType.Hardware__c.Fields.InvNo__c.Label}" /></th>
                                            <th class="table-col-30"><apex:outputText value="{!$Label.DeviceType}"/></th>
                                        </tr>
                                    </thead>

                                    <tbody>
                                        <apex:repeat value="{!deviceConfigurationList}" var="hardwareUnit">
                                            <tr style="background-color: white;" class="table-row">
                                                <td class="table-col-40" title="{!hardwareUnit.name}"><p class="overlapping-text"><apex:outputText value="{!hardwareUnit.name}"/></p></td>
                                                <td class="table-col-30" title="{!hardwareUnit.InvNo__c}"><p class="overlapping-text"><apex:outputText value="{!hardwareUnit.InvNo__c}"/></p></td>
                                                <td class="table-col-30" title="{!hardwareUnit.RecordType.name}"><p class="overlapping-text"><apex:outputText value="{!hardwareUnit.RecordType.name}"/></p></td>
                                            </tr>
                                        </apex:repeat>
                                    </tbody>
                                </table>

                                <br/>
                                <br/>

                                <img src="{!deviceImageUrl}"/>

                            </apex:outputPanel>

                        </apex:pageBlock>

                    </apex:outputPanel>
                </apex:form>
            </div>
        </div>

    </apex:pageBlock>

</apex:page>